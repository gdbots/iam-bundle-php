<?xml version="1.0"?>
<container xmlns="http://symfony.com/schema/dic/services"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://symfony.com/schema/dic/services http://symfony.com/schema/dic/services/services-1.0.xsd">

  <!-- This provider requires "auth0/auth0-php" library. -->

  <parameters>
    <parameter key="env(AUTH0_API_IDENTIFIER)"/>
    <parameter key="env(AUTH0_AUTHORIZED_ISSUER)"/>

    <!-- tmp, moving to db -->
    <parameter key="permissions_map" type="collection">
      <parameter key="%app_vendor%:iam:command:create-user">ROLE_SUPER_USER</parameter>
    </parameter>
  </parameters>

  <services>
    <service id="gdbots_iam.security.auth0.jwt_authenticator" class="Gdbots\Bundle\IamBundle\Security\Jwt\Auth0JwtAuthenticator" public="false">
      <argument type="service" id="gdbots_iam.security.auth0.jwt_decoder"/>
    </service>

    <service id="gdbots_iam.security.auth0.cache_handler" class="Gdbots\Bundle\IamBundle\Security\Jwt\Auth0CacheHandler" public="false">
      <argument type="service" id="cache.app"/>
    </service>

    <service id="gdbots_iam.security.auth0.jwt_decoder" class="Gdbots\Bundle\IamBundle\Security\Jwt\Auth0JwtDecoder" public="false">
      <argument type="service" id="gdbots_iam.security.auth0.cache_handler"/>
      <argument>%env(AUTH0_API_IDENTIFIER)%</argument>
      <argument>%env(AUTH0_AUTHORIZED_ISSUER)%</argument>
    </service>

    <service id="gdbots_iam.security.auth0.user_provider" class="Gdbots\Bundle\IamBundle\Security\Jwt\Auth0UserProvider">
      <argument type="service" id="pbjx"/>
      <argument type="service" id="request_stack"/>
    </service>

    <service id="gdbots_iam.security.pbjx_permission_voter" class="Gdbots\Bundle\IamBundle\Security\PbjxPermissionVoter" public="false">
      <argument type="service" id="security.access.decision_manager"/>
      <argument>%permissions_map%</argument>
      <tag name="security.voter"/>
    </service>

    <!-- binders -->
    <service id="gdbots_iam.security.ctx_user_ref_binder" class="Gdbots\Bundle\IamBundle\Binder\CtxUserRefBinder">
      <argument type="service" id="security.token_storage"/>
      <tag name="pbjx.event_subscriber"/>
    </service>

    <!-- validators -->
    <service id="gdbots_iam.security.pbjx_permission_validator" class="Gdbots\Bundle\IamBundle\Security\PbjxPermissionValidator">
      <argument type="service" id="request_stack"/>
      <argument type="service" id="security.authorization_checker"/>
      <tag name="pbjx.event_subscriber"/>
    </service>
  </services>

</container>
