<?xml version="1.0"?>
<container xmlns="http://symfony.com/schema/dic/services"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://symfony.com/schema/dic/services http://symfony.com/schema/dic/services/services-1.0.xsd">

  <!-- This provider requires "hwi/oauth-bundle" bundle. -->

  <parameters>
    <!-- tmp, moving to db -->
    <parameter key="permissions_map" type="collection">
      <parameter key="%app_vendor%:iam:command:create-user">ROLE_SUPER_USER</parameter>
    </parameter>

    <!-- the Auth0 lock only uses a state variable, not a full auth url -->
    <parameter key="hwi_oauth.storage.session.class">Gdbots\Bundle\IamBundle\Security\OAuth\Auth0SessionStorage</parameter>
  </parameters>

  <services>
    <service id="gdbots_iam.security.oauth.auth0_user_provider" class="Gdbots\Bundle\IamBundle\Security\OAuth\Auth0UserProvider">
      <argument type="service" id="pbjx"/>
      <argument type="service" id="request_stack"/>
    </service>

    <service id="gdbots_iam.security.pbjx_permission_voter" class="Gdbots\Bundle\IamBundle\Security\PbjxPermissionVoter" public="false">
      <argument type="service" id="security.access.decision_manager"/>
      <argument>%permissions_map%</argument>
      <tag name="security.voter"/>
    </service>

    <!-- binders -->
    <service id="gdbots_iam.security.ctx_user_ref_binder" class="Gdbots\Bundle\IamBundle\Binder\CtxUserRefBinder">
      <argument type="service" id="security.token_storage"/>
      <tag name="pbjx.event_subscriber"/>
    </service>

    <!-- validators -->
    <service id="gdbots_iam.security.pbjx_permission_validator" class="Gdbots\Bundle\IamBundle\Security\PbjxPermissionValidator">
      <argument type="service" id="request_stack"/>
      <argument type="service" id="security.authorization_checker"/>
      <tag name="pbjx.event_subscriber"/>
    </service>

    <!-- request handlers -->
  </services>

</container>
