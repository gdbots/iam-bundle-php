<?xml version="1.0"?>
<container xmlns="http://symfony.com/schema/dic/services"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://symfony.com/schema/dic/services http://symfony.com/schema/dic/services/services-1.0.xsd">

  <!-- This provider requires "auth0/auth0-php" library. -->

  <parameters>
    <parameter key="env(AUTH0_API_IDENTIFIER)"/>
    <parameter key="env(AUTH0_AUTHORIZED_ISSUER)"/>
    <parameter key="env(AUTH0_SIGNING_SECRET)"/>
    <parameter key="env(IAM_POLICY_TTL)">120</parameter>
    <parameter key="gdbots_iam.auth0_controller.class">Gdbots\Bundle\IamBundle\Controller\Auth0Controller</parameter>
    <parameter key="gdbots_iam.pbjx_permission_voter.class">Gdbots\Bundle\IamBundle\Security\PbjxPermissionVoter</parameter>

  </parameters>

  <services>
    <defaults public="false"/>

    <service id="gdbots_iam.auth0_controller" class="%gdbots_iam.auth0_controller.class%" public="true">
      <argument type="service" id="ncr"/>
      <call method="setContainer">
        <argument type="service" id="service_container"/>
      </call>
    </service>

    <service id="gdbots_iam.auth0_jwt_authenticator" class="Gdbots\Bundle\IamBundle\Security\Jwt\Auth0JwtAuthenticator">
      <argument type="service" id="gdbots_iam.auth0_jwt_decoder"/>
    </service>

    <service id="gdbots_iam.auth0_cache_handler" class="Gdbots\Bundle\IamBundle\Security\Jwt\Auth0CacheHandler">
      <argument type="service" id="cache.app"/>
    </service>

    <service id="gdbots_iam.auth0_jwt_decoder" class="Gdbots\Bundle\IamBundle\Security\Jwt\Auth0JwtDecoder">
      <argument type="service" id="gdbots_iam.auth0_cache_handler"/>
      <argument>%env(AUTH0_API_IDENTIFIER)%</argument>
      <argument>%env(AUTH0_AUTHORIZED_ISSUER)%</argument>
      <argument>%env(AUTH0_SIGNING_SECRET)%</argument>
    </service>

    <service id="gdbots_iam.auth0_user_provider" class="Gdbots\Bundle\IamBundle\Security\Jwt\Auth0UserProvider">
      <argument type="service" id="pbjx"/>
      <argument type="service" id="request_stack"/>
    </service>

    <service id="gdbots_iam.pbjx_permission_voter" class="%gdbots_iam.pbjx_permission_voter.class%">
      <argument type="service" id="pbjx"/>
      <argument type="service" id="cache.app"/>
      <argument type="service" id="request_stack"/>
      <argument>%env(int:IAM_POLICY_TTL)%</argument>
      <tag name="security.voter"/>
    </service>

    <!-- binders -->
    <service id="gdbots_iam.ctx_user_ref_binder" class="Gdbots\Bundle\IamBundle\Binder\CtxUserRefBinder">
      <argument type="service" id="security.token_storage"/>
      <tag name="pbjx.event_subscriber"/>
      <tag name="pbjx.binder"/>
    </service>

    <!-- validators -->
    <service id="gdbots_iam.pbjx_permission_validator" class="Gdbots\Bundle\IamBundle\Validator\PbjxPermissionValidator">
      <argument type="service" id="request_stack"/>
      <argument type="service" id="security.authorization_checker"/>
      <tag name="pbjx.event_subscriber"/>
      <tag name="pbjx.validator"/>
    </service>
  </services>

</container>
